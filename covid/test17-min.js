//https://javascript-minifier.com/
"use strict";var lastFaceData,canvas,ctx,cl=console.log,options={probabiltyScaling:.01},haveProcessedAtLeastOneImage=!1,imageIsLoadedIntoCanvas=!1;function setup(){var e=document.getElementById("imageInput"),t=document.getElementById("imageEle");e.addEventListener("change",function(){this.files&&this.files[0]&&(t.src=URL.createObjectURL(this.files[0]),t.onload=loadImageIntoCanvas)}),cl("load models start");var a=0;faceapi.nets.ssdMobilenetv1.loadFromUri("models"),cl("loaded model "+ ++a),faceapi.loadFaceLandmarkModel("models"),cl("loaded model "+ ++a),faceapi.loadFaceRecognitionModel("models"),cl("loaded model "+ ++a),faceapi.loadAgeGenderModel("models"),cl("loaded model "+ ++a),faceapi.loadFaceExpressionModel("models"),cl("loaded model "+ ++a),cl("loaded all models")}function rotateImageInCanvas(){imageIsLoadedIntoCanvas?(ctx.save(),ctx.translate(canvas.width/2,canvas.width/2),ctx.rotate(Math.PI/2),ctx.drawImage(canvas,0,0,canvas.width,canvas.width,-canvas.width/2,-canvas.width/2,canvas.width,canvas.width),ctx.translate(-canvas.width/2,-canvas.width/2),ctx.restore()):cl("not rotating, no image loaded into canvas")}function loadImageIntoCanvas(){cl(this);(canvas=document.getElementById("resultsCanvas")).width=1e3,canvas.height=1e3,ctx=canvas.getContext("2d"),cl(this.width,this.height),this.width>this.height?ctx.drawImage(this,(this.width-this.height)/2,0,this.height,this.height,0,0,canvas.width,canvas.height):ctx.drawImage(this,0,(this.height-this.width)/2,this.width,this.width,0,0,canvas.width,canvas.height),imageIsLoadedIntoCanvas=!0}async function loadResultsData(){var e=document.getElementById("resultsProgressDiv");e.innerHTML+="analysis start<br>";var t=await faceapi.detectSingleFace(canvas).withFaceLandmarks().withFaceDescriptor().withAgeAndGender().withFaceExpressions();if(e.innerHTML+="analysis end<br>",cl(t),void 0===t)e.innerHTML+="No face found<br>",e.innerHTML+="Ensure face well lit and positioned in frame.<br>Rotate image if required into upright position.";else{lastFaceData=t,renderFaceLandmarks(t);var a=new faceapi.FaceMatcher(lastFaceData).computeMeanDistance(lastFaceData.descriptor,toCompareAgainstDescriptors);cl("faceRecogMeanDist: "+a);var n=Math.exp(1/(3*a))-Math.exp(1/3);cl(n);var i=Math.round(10*(n-Math.floor(n)));cl(i);document.getElementById("resultsAgeDiv").innerHTML="Age: "+Math.round(t.age)+", &sigma;="+Math.round(.2*t.age),document.getElementById("resultsGenderDiv").innerHTML=t.gender[0].toUpperCase()+t.gender.substr(1)+", P="+t.genderProbability,document.getElementById("resultsExpressionsDiv").innerHTML=getExpressionsAsText(t.expressions),document.getElementById("resultsGeneralDiv").innerHTML="",document.getElementById("resultsScoreDiv").innerHTML="Weighted end node result: "+n;var r="";for(r+="Debug<br>",r+="Descriptor:<br>",l=0;l<t.descriptor.length;l++)r+=t.descriptor[l]+", ";for(r+="<br><br>Euclidean distances:<br>",l=-1;l<1.1;l+=.1)r+=Math.round(10*l)/10+": "+getDistOfFaceDescriptorFromSetValue(t.descriptor,l)+",<br>";document.getElementById("resultsDetailsDiv").innerHTML=r;var s=Math.tanh(n);if(cl(s),s>.5?(document.getElementById("resultsProbabiltyPercentDiv").innerHTML=(100*s).toFixed(3)+"&#37;",document.getElementById("resultsProbabiltyResultDiv").innerHTML="Infected",document.getElementById("resultsProbabiltyContainerDiv").style.backgroundColor="#F00"):(document.getElementById("resultsProbabiltyPercentDiv").innerHTML=(100*(1-s)).toFixed(3)+"&#37;",document.getElementById("resultsProbabiltyResultDiv").innerHTML="Not Infected",document.getElementById("resultsProbabiltyContainerDiv").style.backgroundColor="#e6e6e6"),!haveProcessedAtLeastOneImage){var l,o=document.getElementsByClassName("hideUntilOneImageProcessedContainer");for(l=0;l<o.length;l++)o[l].style.visibility="visible";haveProcessedAtLeastOneImage=!0}}}function getExpressionsAsText(e){var t,a=[{name:"Neutral",value:e.neutral},{name:"Happy",value:e.happy},{name:"Sad",value:e.sad},{name:"Angry",value:e.angry},{name:"Fearful",value:e.fearful},{name:"Disgusted",value:e.disgusted},{name:"Surprised",value:e.surprised}];a.sort(function(e,t){return t.value-e.value});var n="";for(n+=a[0].name+" P="+a[0].value+"<br>",t=1;t<a.length&&.7*a[t-1].value<a[t].value;t++)n+=a[t].name+" ,P="+a[t].value+"<br>";return n}function renderFaceLandmarks(e){var t=faceapi.resizeResults(e,{width:canvas.width,height:canvas.height});faceapi.draw.drawDetections(canvas,t),faceapi.draw.drawFaceLandmarks(canvas,t);faceapi.draw.drawFaceExpressions(canvas,t,.05)}function getDistOfFaceDescriptorFromSetValue(e,t){var a,n=0;for(a=0;a<e.length;a++)n+=Math.pow(e[a]-t,2);return Math.sqrt(n)}function genToCopyArrFromDescriptor(e){var t,a="["+e[0];for(t=1;t<e.length;t++)a+=","+e[t];return a+="]"}function openSocialShare(e){if(haveProcessedAtLeastOneImage){var t="";t+="COVID-19 Facial Signature Detector result:",t+="\n*"+document.getElementById("resultsProbabiltyResultDiv").innerHTML+"!*\n",t+="Confidence level: "+document.getElementById("resultsProbabiltyPercentDiv").innerHTML,t+="\nTake the test yourself! https://covidtest.cf https://capetiernia.github.io/covid \n(image processed entirely on device)\n",t+="Made by the Cape Tiernia University Infectious Diseases Research Center",t+=" #CapeTiernia #coronavirus #COVID19",t="",t+="COVID-19 Facial Signature Detector result:",t+="\n*"+document.getElementById("resultsProbabiltyResultDiv").innerHTML+"!*\n",t+="Confidence level: "+document.getElementById("resultsProbabiltyPercentDiv").innerHTML,t+="\nTake the test yourself! https://covidtest.cf https://capetiernia.github.io/covid\n",t+="Made by the Cape Tiernia University Infectious Diseases Research Center",t+=" #CapeTiernia #coronavirus #COVID19";var a=encodeURI(t).split("#").join("%23");switch(cl(t),cl(a),e){case"tw":case"twitter":window.open("https://twitter.com/intent/tweet?text="+a);break;case"fb":case"facebook":window.open("https://www.facebook.com/sharer/sharer.php?u"+a);break;case"email":window.open("mailto:?subject=SARS-CoV-2&body="+a);break;case"image":createShareImage();var n="<iframe width='100%' height='100%' src='"+document.getElementById("shareImageGenCanvas").toDataURL()+"'></iframe>",i=window.open();i.document.open(),i.document.write(n),i.document.close();break;default:console.error("ERROR, platformName unknown "+e)}}else cl("not opening share, haveProcessedAtLeastOneImage is false")}function createShareImage(){var e=document.getElementById("shareImageGenCanvas");e.width=1080,e.height=1080;var t=e.getContext("2d");t.fillTextCentered=function(t,a){this.fillText(t,e.width/2-this.measureText(t).width/2,a)},t.fillStyle="white",t.fillRect(0,0,e.width,e.height),t.fillStyle="black",t.font="130px Arial",t.fillTextCentered("SARS-CoV-2",170),t.font="65px Arial",t.fillTextCentered("Facial Signature Detector",260),t.font="30px Arial",t.fillTextCentered("Made by the Cape Tiernia University Infectious Diseases Research Center",330),"Infected"===document.getElementById("resultsProbabiltyResultDiv").innerHTML?t.fillStyle="red":t.fillStyle="#00ff7b",t.fillRect((e.width-900)/2,400,900,400),t.font="80px Arial",t.fillStyle="black",t.fillTextCentered(document.getElementById("resultsProbabiltyResultDiv").innerHTML,500),t.font="150px Arial",t.fillTextCentered(document.getElementById("resultsProbabiltyPercentDiv").innerHTML,650),t.font="60px Arial",t.fillTextCentered("Confidence level",750),t.font="60px Arial",t.fillTextCentered("Take the test yourself!",880),t.font="90px Arial",t.fillStyle="red",t.fillTextCentered("www.covidtest.ga",970),t.font="60px Arial",t.fillTextCentered("capetiernia.github.io/covid",1040)}
